Before deploying Prisma Cloud to our OpenShift cluster, we must first prepare our enviornment. In this step, we will configure the project and pull required docker images to our image cache ready for installation in step 2. 

## Create User

First we need to create a user: 

`htpasswd -c /etc/origin/openshift-htpasswd twistlock`{{execute}}

`oc create user twistlock`{{execute}}

`oc adm policy add-role-to-user admin twistlock -n default`{{execute}}

Configure registry access for twistlock user: 

`oc adm policy add-role-to-user system:registry twistlock`{{execute}}

`oc adm policy add-role-to-user system:image-builder twistlock`{{execute}}

## Create Project

**Project** Openshift provide us with the ability to isolate resources into seperate workloads. This gives us many capabilities, such as being able to set up resourse constraints on workloads and establishing clear security boundaries. 

Let's take a look at our current projects:

`oc get projects`{{execute}}

Now let's create a **Project** which we'll use to contain our Prisma deployment:

`oc adm new-project twistlock --node-selector=''`{{execute}}

Great, now check our project was created successfully:

`oc get projects`{{execute}}

Give the twistlock user access 

`oc adm policy add-role-to-user admin twistlock -n twistlock`{{execute}}
## Login

Login as Twistlock user:

`oc login https://localhost:8443`{{execute}}


## Download Artifacts

Now that our project is created, let's import the neccessary artifacts we need to proceed with our Prisma deployment. Go to the [releases page](https://docs.twistlock.com/docs/19.11/download/releases.html) and login with your subscriptions token. Copy the download link for the latest release to your clipboard

![alt text](https://raw.githubusercontent.com/jameswhinn/katalabs/master/twistlock-openshift/assets/tlrel.png "Releases")

Download the release tarball to your cluster controller:

`wget <LINK_TO_CURRENT_RECOMMENDED_RELEASE_LINK>`

Unpack the release tarball:

`mkdir twistlock`{{execute}}

`tar xvzf prisma_cloud_compute_edition_<VERSION>.tar.gz -C twistlock/`{{execute}}

## Pull Images

Now we need to pull the defender and console iages from the twistlock repository. Pull the images from the Prisma Cloud cloud registry using your access token. The major, minor, and patch numerals in the <VERSION> string are separated with an underscore. For exampe, 18.11.128 would be 18_11_128

`docker pull registry-auth.twistlock.com/tw_<ACCESS_TOKEN>/twistlock/defender:defender_<VERSION>`{{execute}}

`docker pull registry-auth.twistlock.com/tw_<ACCESS_TOKEN>/twistlock/console:console_<VERSION>`{{execute}}

## Push Images to Openshift Registry

Now tag and push the images to the local registy. First grab the registry endpoint:

`oc get svc -n default`{{execute}}

Then tag the images: 

`docker tag registry-auth.twistlock.com/tw_<ACCESS_TOKEN>/twistlock/defender:defender_<VERSION> <REGISTRY_ENDPOINT>:5000/twistlock/private:defender_<VERSION>`{{execute}}

`docker tag registry-auth.twistlock.com/tw_<ACCESS_TOKEN>/twistlock/console:console_<VERSION> <REGISTRY_ENDPOINT>:5000/twistlock/private:console<VERSION>`{{execute}}

Finally push the images:

`docker login <REGISTRY_ENDPOINT>:5000 -u twistlock -p $(oc whoami -t)`{{execute}}

`docker push <REGISTRY_ENDPOINT>:5000/twistlock/private:console<VERSION>`{{execute}}

`docker push <REGISTRY_ENDPOINT>:5000/twistlock/private:defender<VERSION>`{{execute}}